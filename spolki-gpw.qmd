---
title: "Spółki GPW"
subtitle: "Interaktywna tabela notowań spółek giełdowych"
pagetitle: "Spółki GPW | Tabela notowań"
format:
  html:
    header-includes: |
      <meta name="description" content="Interaktywna tabela spółek GPW z notowaniami i zmianami cen. Wyszukiwarka i sortowanie.">
---

```{r setup, include=FALSE}
library(dplyr)
library(DT)

# Define company list
companies <- data.frame(
  ticker = c(
    "11B", "ACP", "ALE", "ALR", "APT", "APR", "ASB", "ATT", "BCX", "BDX", "BFT", "BHW", "CAR", "CCC", "CDR", "CIG", "CPS", "CRI", "DAD", "DAT", "DIA", "DIG", "DNP", "DVL",
    "EAT", "ECH", "ELT", "ENA", "ENG", "FRO", "GPW", "GPP", "GRX", "IFR", "ING", "JSW", "KGH", "KER", "KRU", "KTY", "LBW", "LPP", "MBK", "MBR", "MDG", "MIL", "MRB",
    "OPL", "PCO", "PCR", "PEO", "PEP", "PGE", "PKN", "PKO", "PKP", "PLW", "PXM", "PZU", "RBW", "RVU", "SCP", "SLV", "SNT", "SPL", "SPR", "TEN", "TOA", "TOR", "TPE", "TRK", "TXT", "VRG", "WTN", "WPL", "XTB", "ZAB"
  ),
  name = c(
    "11 bit studios", "Asseco Poland", "Allegro.eu", "Alior Bank", "Apator", "Auto Partner", "Asbis", "Grupa Azoty", "Bioceltix", "Budimex", "Benefit Systems", "Bank Handlowy", "Inter Cars", "Grupa CCC", "CD PROJEKT", "CI Games", "Cyfrowy Polsat", "Creotech", "Dadelo", "DataWalk", "Diagnostyka", "Digital Network", "DINO POLSKA", "Develia",
    "AmRest", "Echo Investment", "Elektrotim", "ENEA", "ENERGA", "Ferro", "Giełda Papierów Wartościowych", "Grupa Pracuj", "GreenX Metals", "Investment Friends", "ING Bank Śląski", "Jastrzębska Spółka Węglowa", "KGHM Polska Miedź", "Kernel Holding", "KRUK", "Grupa Kęty", "Lubawa", "LPP", "mBank", "Mo-BRUK", "Medicalgorithmics", "Bank Millennium", "MIRBUD",
    "Orange Polska", "Pepco Group", "PCC Rokita", "Bank Pekao", "Polenergia", "PGE Polska Grupa Energetyczna", "ORLEN", "PKO Bank Polski", "PKP Cargo", "Playway", "Polimex-Mostostal", "PZU", "Rainbow Tours", "Ryvu Therapeutics", "Scope Fluidics", "Selvita", "Synektik", "Santander Bank Polska", "Spyrosoft", "Ten Square Games", "Toya", "Torpol", "Tauron Polska Energia", "Trakcja", "Text", "Vistula Retail Group", "Wittchen", "Wirtualna Polska", "XTB", "Żabka Group"
  ),
  stringsAsFactors = FALSE
)

# Load price data
prices_path <- file.path(getwd(), "data/prices100.RDS")
prices_all <- readRDS(prices_path)

# Load industry mapping
branze_csv <- read.csv("data/branze_podbranze.csv", stringsAsFactors = FALSE)
# Set of valid Industries (used for validation)
valid_inds <- unique(branze_csv$branza)

# Function to extract categories from qmd files
get_categories <- function(ticker) {
  file_path <- file.path("spolki", paste0(tolower(ticker), ".qmd"))
  if (!file.exists(file_path)) return(NA)
  
  lines <- readLines(file_path, n = 20)
  cat_line <- grep("^categories:", lines, value = TRUE)
  if (length(cat_line) > 0) {
    # Extract content inside []
    cats <- gsub("categories: \\[(.*)\\]", "\\1", cat_line)
    # Split by comma and clean
    cats_vec <- trimws(unlist(strsplit(cats, ",")))
    return(cats_vec)
  }
  return(NA)
}

# Build table row by row
result_rows <- list()
all_categories <- c()

for (i in 1:nrow(companies)) {
  tick <- companies$ticker[i]
  comp_name <- companies$name[i]
  
  # Get category from file
  raw_cats <- get_categories(tick)
  final_cat <- NA
  
  if (!is.na(raw_cats[1])) {
    # Logic to map to Industry
    # 1. Check if any raw cat is a Main Industry
    ind_match <- intersect(raw_cats, valid_inds)
    
    if (length(ind_match) > 0) {
       final_cat <- ind_match[1] 
    } else {
       # Since we updated all files, this should be rare.
       final_cat <- raw_cats[1] 
    }
    
    if (!is.na(final_cat)) {
       all_categories <- unique(c(all_categories, final_cat))
    }
  }

  # Check if ticker exists
  if (!tick %in% names(prices_all)) {
    result_rows[[i]] <- data.frame(
      ticker = tick,
      name = comp_name,
      categories = final_cat,
      last_price = NA,
      change_pct = NA,
      last_date = as.Date(NA),
      sparkline = "",
      stringsAsFactors = FALSE
    )
    next
  }

  # Get price data
  tick_df <- prices_all[, c("Date", tick)]
  names(tick_df) <- c("date", "price")
  tick_df <- tick_df[!is.na(tick_df$price), ]
  tick_df <- tick_df[order(tick_df$date), ]

  if (nrow(tick_df) == 0) {
    result_rows[[i]] <- data.frame(
      ticker = tick,
      name = comp_name,
      categories = final_cat,
      last_price = NA,
      change_pct = NA,
      last_date = as.Date(NA),
      sparkline = "",
      stringsAsFactors = FALSE
    )
    next
  }

  # Get last price and change
  last_price <- as.numeric(tail(tick_df$price, 1))
  prev_price <- as.numeric(tail(tick_df$price, 2)[1])
  last_date <- tail(tick_df$date, 1)

  # Get last 30 days for sparkline
  spark_data <- tail(tick_df$price, 30)
  if (length(spark_data) >= 2) {
    # Normalize to 0-20 range for SVG
    min_p <- min(spark_data, na.rm = TRUE)
    max_p <- max(spark_data, na.rm = TRUE)
    range_p <- ifelse(max_p - min_p > 0, max_p - min_p, 1)
    normalized <- ((spark_data - min_p) / range_p) * 20
    # Create SVG path
    step <- 80 / (length(normalized) - 1)
    path_d <- paste0("M0,", 20 - normalized[1])
    for (j in 2:length(normalized)) {
      path_d <- paste0(path_d, " L", (j-1) * step, ",", 20 - normalized[j])
    }
    # Determine color based on trend
    trend_color <- ifelse(tail(spark_data,1) >= head(spark_data,1), "#28a745", "#dc3545")
    sparkline_svg <- paste0(
      "<svg width='80' height='20' style='display:block; margin-top:4px;'>",
      "<path d='", path_d, "' stroke='", trend_color, "' fill='none' stroke-width='1.5'/>",
      "</svg>"
    )
  } else {
    sparkline_svg <- ""
  }

  change_pct <- NA
  if (!is.na(prev_price) && prev_price > 0) {
    change_pct <- ((last_price - prev_price) / prev_price) * 100
  }

  result_rows[[i]] <- data.frame(
    ticker = tick,
    name = comp_name,
    categories = final_cat,
    last_price = last_price,
    change_pct = change_pct,
    last_date = last_date,
    sparkline = sparkline_svg,
    stringsAsFactors = FALSE
  )
}

# Combine results
company_data <- do.call(rbind, result_rows)

# Format for display
# Fix links: use lowercase ticker and correct path
company_data$company <- paste0(
  "<a href='./spolki/", tolower(company_data$ticker), ".html' style='color:#2c3e50; font-weight:600;'>",
  company_data$ticker, "</a><br><span style='color:#6c757d; font-size:0.85em;'>",
  company_data$name, "</span>"
)

# Format date (dd.mm.rrrr)
company_data$date_fmt <- ifelse(
  is.na(company_data$last_date), "",
  format(company_data$last_date, "%d.%m.%Y")
)

# Price with date below
company_data$price_fmt <- paste0(
  sprintf("%.2f", company_data$last_price),
  "<br><span style='color:#6c757d; font-size:0.75em;'>", company_data$date_fmt, "</span>"
)

company_data$change_fmt <- ifelse(
  is.na(company_data$change_pct), "—",
  ifelse(
    company_data$change_pct > 0,
    paste0("<span style='color:#28a745; font-weight:600;'>+", sprintf("%.2f", company_data$change_pct), "%</span>"),
    ifelse(
      company_data$change_pct < 0,
      paste0("<span style='color:#dc3545; font-weight:600;'>", sprintf("%.2f", company_data$change_pct), "%</span>"),
      "<span style='color:#6c757d;'>0.00%</span>"
    )
  )
)

# Format categories as badges
company_data$cat_fmt <- sapply(company_data$categories, function(x) {
  if (is.na(x)) return("")
  # Map to standard badge
  paste0("<span class='badge bg-light text-dark border' style='cursor:pointer;' onclick='filterCategory(\"", x, "\")'>", x, "</span>")
})

# Final table
final_table <- data.frame(
  "Spółka" = company_data$company,
  "Branża" = company_data$cat_fmt,
  "Cena" = company_data$price_fmt,
  "Trend 30D" = company_data$sparkline,
  "Zmiana" = company_data$change_fmt,
  stringsAsFactors = FALSE
)

# Sort categories alphabetically
all_categories <- sort(all_categories)

# DEBUG: Print categories
cat("\n\nDEBUG all_categories:\n")
print(all_categories)
cat("\n\n")
```

## Notowania spółek GPW

Poniższa tabela zawiera notowania wybranych spółek z GPW. Możesz wyszukiwać po nazwie lub tickerze oraz sortować kolumny.

::: {.callout-tip}
## Jak korzystać
*   **Wyszukiwanie** — wpisz ticker (np. "PKO") lub nazwę w polu nad tabelą
*   **Sortowanie** — kliknij nagłówek kolumny
:::

```{r}
#| echo: false
#| results: asis

# Generate category dropdown
cat('<div class="category-filters mb-3">')
cat('<label for="categorySelect" class="form-label me-2 fw-bold">Wybierz branżę:</label>')
cat('<select id="categorySelect" class="form-select d-inline-block w-auto" onchange="filterCategory(this.value)">')
cat('<option value="all">Wszystkie</option>')
for(cat_name in all_categories) {
  cat(paste0('<option value="', cat_name, '">', cat_name, '</option>'))
}
cat('</select>')
cat('</div>')

# Add JavaScript for filtering
cat(paste0('
<script>
$(document).ready(function() {
  // Initialize DataTable
  var table = $(".dataTable").DataTable();
  
  // Expose filter function globally
  window.filterCategory = function(category) {
    var rawCat = decodeURIComponent(category);
    var targetCat = rawCat;
    
    // Update dropdown value
    if($("#categorySelect").val() !== targetCat) {
      if(targetCat === "all" || !$("#categorySelect option[value=\'" + targetCat + "\']").length) {
         $("#categorySelect").val("all");
      } else {
         $("#categorySelect").val(targetCat);
      }
    }
    
    var val = $("#categorySelect").val();

    if(val === "all") {
      table.column(1).search("").draw();
      history.pushState("", document.title, window.location.pathname + window.location.search);
    } else {
      table.column(1).search(val).draw();
      window.location.hash = "category=" + encodeURIComponent(val);
    }
  };

  // Check URL hash on load
  var hash = window.location.hash;
  if(hash && hash.includes("category=")) {
    var category = hash.split("category=")[1]; 
    filterCategory(decodeURIComponent(category));
  }
});
</script>
'))

```{r}
#| echo: false
datatable(
  final_table,
  rownames = FALSE,
  escape = FALSE,
  options = list(
    pageLength = 20,
    lengthMenu = c(10, 20, 50, 100),
    order = list(list(0, "asc")), # Sort by Name (idx 0)
    columnDefs = list(
      list(targets = 0, width = "200px"), # Spółka
      list(targets = 1, width = "150px"), # Branża
      list(targets = 2, width = "100px"), # Cena
      list(targets = 3, width = "100px"), # Trend
      list(targets = 4, width = "100px")  # Zmiana
    ),
    dom = "ftipl"
  ),
  class = "display cell-border stripe hover"
)
```

::: {.callout-note}
## Disclaimer
Notowania mają charakter wyłącznie informacyjny i nie stanowią rekomendacji inwestycyjnej. Dane pochodzą z zewnętrznych źródeł i mogą być opóźnione.
:::
